use role securityadmin;

-- set name of demo
set var_demo = 'json_parsing';

set var_demo_role = $var_demo || '_role';
create or replace role identifier( $var_demo_role );
set var_current_user = current_user();
grant role identifier( $var_demo_role ) to user identifier( $var_current_user );

use role sysadmin;
set var_demo_wh = $var_demo || '_wh';
create or replace warehouse identifier( $var_demo_wh );
use warehouse identifier( $var_demo_wh );
set var_demo_db = $var_demo || '_db';
create or replace database identifier( $var_demo_db );
set var_demo_schema = $var_demo_db || '.demo';
create or replace schema identifier( $var_demo_schema );

grant usage on warehouse identifier( $var_demo_wh ) to role identifier( $var_demo_role );
grant all privileges on database identifier( $var_demo_db ) to role identifier( $var_demo_role );
grant all privileges on schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );
grant all privileges on all tables in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );
grant all privileges on all views in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );
grant all privileges on all materialized views in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );

use role securityadmin;
grant all privileges on future tables in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );
grant all privileges on future views in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );
grant all privileges on future materialized views in schema identifier( $var_demo_schema ) to role identifier( $var_demo_role );


-- demo
use role identifier( $var_demo_role );
use warehouse identifier( $var_demo_wh );
use schema identifier( $var_demo_schema );

create or replace table json_raw (json variant );

insert into json_raw 
select parse_json(
'{
    "coupons": [
        {
            "code": "HAPPYHOLIDAY",
            "amount": 25.0
        }, {
            "code": "BIRTHDAY",
            "amount": 30.0
        }
    ]
}');

select  json.*
        ,value:code::string as code
        ,value:amount::number as amount
from    json_raw as json
        ,lateral flatten ( input => json:coupons ) as json_lf
where   value:code::string = 'BIRTHDAY';
